services:
  postgres:
    restart: always
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

  redis:
    restart: always

  api:
    restart: always
    build:
      context: ./api
      dockerfile: Dockerfile
      target: production
    environment:
      DATABASE_URL: postgres://betteratlas:${POSTGRES_PASSWORD}@postgres:5432/betteratlas
      REDIS_URL: redis://redis:6379
      SESSION_SECRET: ${SESSION_SECRET}
      API_PORT: "3001"
      NODE_ENV: production
      PROGRAMS_SYNC_SECRET: ${PROGRAMS_SYNC_SECRET}
      ADMIN_EMAILS: ${ADMIN_EMAILS}
      METRICS_DISK_PATH: ${METRICS_DISK_PATH:-/}
    volumes: []

  frontend:
    restart: always
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: production
    ports:
      - "80:80"
    volumes: []

  nginx:
    image: nginx:alpine
    restart: always
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api
      - frontend
