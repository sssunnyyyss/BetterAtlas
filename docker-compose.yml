services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
      target: development
    ports:
      - "3001:3001"
    environment:
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o-mini}
      DATABASE_URL: ${DATABASE_URL_DOCKER}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
      API_PORT: "3001"
      NODE_ENV: development
      ATLAS_TERM_CODE: ${ATLAS_TERM_CODE:-}
      ATLAS_SUBJECTS: ${ATLAS_SUBJECTS:-ALL}
      ATLAS_DETAILS_MODE: ${ATLAS_DETAILS_MODE:-sampled}
      ATLAS_CAMPUSES: ${ATLAS_CAMPUSES:-ATL@ATLANTA,OXF@OXFORD}
      ATLAS_CONCURRENCY: ${ATLAS_CONCURRENCY:-6}
      ATLAS_RATE_DELAY_MS: ${ATLAS_RATE_DELAY_MS:-0}
      PROGRAMS_SYNC_SECRET: ${PROGRAMS_SYNC_SECRET:-}
      ADMIN_EMAILS: ${ADMIN_EMAILS:-}
      METRICS_DISK_PATH: ${METRICS_DISK_PATH:-/}
    volumes:
      - ./api/src:/app/api/src:cached
      - ./packages/shared/src:/app/packages/shared/src:cached
      - ./packages/shared/dist:/app/packages/shared/dist:cached
      - ./schema-migration.sql:/app/schema-migration.sql:cached
      - /app/api/node_modules
      - /app/packages/shared/node_modules

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      target: production
    ports:
      - "80:80"
    depends_on:
      - api
    environment:
      VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
      VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
